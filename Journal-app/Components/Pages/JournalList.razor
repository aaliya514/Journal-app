@page "/journal-list"
@inject JournalService JournalService
@inject NavigationManager Navigation

<div style="min-height: 100vh; padding: 2rem;">
    <div style="max-width: 1200px; margin: 0 auto;">
        
        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <h1 style="font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">
                        All Entries
                    </h1>
                    <p style="color: #64748b; font-size: 1rem;">@filteredEntries.Count total entries</p>
                </div>
                <button @onclick="GoToDashboard" style="padding: 0.75rem 1.5rem; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    Back to Dashboard
                </button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <input type="text" @bind="searchText" @bind:event="oninput" @bind:after="PerformSearch" placeholder="Search by title, content, or tags..." style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem;" />
            </div>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                <select @bind="filterMood" @bind:after="ApplyFilters" style="padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem;">
                    <option value="">All Moods</option>
                    @foreach (var category in MoodConstants.MoodCategories)
                    {
                        <optgroup label="@category.Key">
                            @foreach (var mood in category.Value)
                            {
                                <option value="@mood">@MoodConstants.GetMoodEmoji(mood) @mood</option>
                            }
                        </optgroup>
                    }
                </select>

                <input type="date" @bind="filterStartDate" @bind:after="ApplyFilters" style="padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem;" />
                <input type="date" @bind="filterEndDate" @bind:after="ApplyFilters" style="padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem;" />

                @if (!string.IsNullOrEmpty(searchText) || !string.IsNullOrEmpty(filterMood) || filterStartDate.HasValue || filterEndDate.HasValue)
                {
                    <button @onclick="ClearFilters" style="padding: 0.75rem 1.5rem; background: #f1f5f9; color: #64748b; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                        Clear Filters
                    </button>
                }
            </div>
        </div>

        @if (paginatedEntries.Any())
        {
            <div style="margin-bottom: 1rem; color: #64748b; font-size: 0.9rem;">
                Showing @(((currentPage - 1) * pageSize) + 1) to @Math.Min(currentPage * pageSize, filteredEntries.Count) of @filteredEntries.Count entries
            </div>

            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                @foreach (var entry in paginatedEntries)
                {
                    <div @onclick="() => EditEntry(entry.Id)" style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; border: 1px solid #f1f5f9; display: flex; gap: 1.5rem; align-items: start;">
                        
                        <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; min-width: 70px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
                            <div style="font-size: 1.75rem; font-weight: 700; line-height: 1;">@entry.EntryDate.Day</div>
                            <div style="font-size: 0.8125rem; text-transform: uppercase; font-weight: 600; margin-top: 0.25rem; opacity: 0.9;">@entry.EntryDate.ToString("MMM")</div>
                        </div>

                        <div style="flex: 1;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; color: #1e293b;">
                                @(string.IsNullOrWhiteSpace(entry.Title) ? "Untitled Entry" : entry.Title)
                            </h3>
                            
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                                <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.875rem; border-radius: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 2px solid rgba(99, 102, 241, 0.2); font-size: 0.875rem; font-weight: 600;">
                                    @MoodConstants.GetMoodEmoji(entry.PrimaryMood) @entry.PrimaryMood
                                </span>
                                @if (!string.IsNullOrWhiteSpace(entry.SecondaryMood1))
                                {
                                    <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.875rem; border-radius: 16px; background: rgba(241, 245, 249, 1); color: #64748b; font-size: 0.8125rem; font-weight: 500;">
                                        @MoodConstants.GetMoodEmoji(entry.SecondaryMood1) @entry.SecondaryMood1
                                    </span>
                                }
                                @if (!string.IsNullOrWhiteSpace(entry.SecondaryMood2))
                                {
                                    <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.875rem; border-radius: 16px; background: rgba(241, 245, 249, 1); color: #64748b; font-size: 0.8125rem; font-weight: 500;">
                                        @MoodConstants.GetMoodEmoji(entry.SecondaryMood2) @entry.SecondaryMood2
                                    </span>
                                }
                            </div>

                            <p style="color: #64748b; line-height: 1.6; margin-bottom: 0.75rem;">
                                @(entry.Content.Length > 200 ? entry.Content.Substring(0, 200) + "..." : entry.Content)
                            </p>

                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <span style="color: #94a3b8; font-size: 0.875rem;">@entry.WordCount words</span>
                                @if (entry.Tags.Any())
                                {
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        @foreach (var tag in entry.Tags.Take(3))
                                        {
                                            <span style="padding: 0.25rem 0.625rem; border-radius: 12px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #075985; border: 1px solid #bae6fd; font-size: 0.75rem; font-weight: 500;">
                                                @tag
                                            </span>
                                        }
                                        @if (entry.Tags.Count > 3)
                                        {
                                            <span style="padding: 0.25rem 0.625rem; border-radius: 12px; background: #f1f5f9; color: #64748b; font-size: 0.75rem; font-weight: 500;">
                                                +@(entry.Tags.Count - 3) more
                                            </span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (totalPages > 1)
            {
                <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; flex-wrap: wrap;">
                    <button @onclick="GoToFirstPage" disabled="@(currentPage == 1)" 
                            style="padding: 0.5rem 1rem; background: @(currentPage == 1 ? "#f1f5f9" : "white"); color: @(currentPage == 1 ? "#94a3b8" : "#6366f1"); border: 2px solid @(currentPage == 1 ? "#e2e8f0" : "#6366f1"); border-radius: 8px; font-weight: 600; cursor: @(currentPage == 1 ? "not-allowed" : "pointer");">
                        First
                    </button>
                    
                    <button @onclick="PreviousPage" disabled="@(currentPage == 1)" 
                            style="padding: 0.5rem 1rem; background: @(currentPage == 1 ? "#f1f5f9" : "white"); color: @(currentPage == 1 ? "#94a3b8" : "#6366f1"); border: 2px solid @(currentPage == 1 ? "#e2e8f0" : "#6366f1"); border-radius: 8px; font-weight: 600; cursor: @(currentPage == 1 ? "not-allowed" : "pointer");">
                        Previous
                    </button>

                    @foreach (var pageNum in GetVisiblePageNumbers())
                    {
                        <button @onclick="() => GoToPage(pageNum)" 
                                style="padding: 0.5rem 1rem; background: @(pageNum == currentPage ? "linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)" : "white"); color: @(pageNum == currentPage ? "white" : "#6366f1"); border: 2px solid #6366f1; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            @pageNum
                        </button>
                    }

                    <button @onclick="NextPage" disabled="@(currentPage >= totalPages)" 
                            style="padding: 0.5rem 1rem; background: @(currentPage >= totalPages ? "#f1f5f9" : "white"); color: @(currentPage >= totalPages ? "#94a3b8" : "#6366f1"); border: 2px solid @(currentPage >= totalPages ? "#e2e8f0" : "#6366f1"); border-radius: 8px; font-weight: 600; cursor: @(currentPage >= totalPages ? "not-allowed" : "pointer");">
                        Next
                    </button>
                    
                    <button @onclick="GoToLastPage" disabled="@(currentPage >= totalPages)" 
                            style="padding: 0.5rem 1rem; background: @(currentPage >= totalPages ? "#f1f5f9" : "white"); color: @(currentPage >= totalPages ? "#94a3b8" : "#6366f1"); border: 2px solid @(currentPage >= totalPages ? "#e2e8f0" : "#6366f1"); border-radius: 8px; font-weight: 600; cursor: @(currentPage >= totalPages ? "not-allowed" : "pointer");">
                        Last
                    </button>
                </div>
            }
        }
        else
        {
            <div style="background: white; padding: 4rem 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“­</div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #1e293b;">No entries found</h3>
                <p style="color: #64748b; margin-bottom: 1.5rem;">
                    @if (!string.IsNullOrEmpty(searchText) || !string.IsNullOrEmpty(filterMood) || filterStartDate.HasValue || filterEndDate.HasValue)
                    {
                        <text>Try adjusting your filters</text>
                    }
                    else
                    {
                        <text>Start writing your first journal entry</text>
                    }
                </p>
                <button @onclick="GoToNewEntry" style="padding: 0.875rem 2rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);">
                    Create Entry
                </button>
            </div>
        }

    </div>
</div>

@code {
    private List<JournalEntry> allEntries = new();
    private List<JournalEntry> filteredEntries = new();
    private string searchText = "";
    private string filterMood = "";
    private DateTime? filterStartDate = null;
    private DateTime? filterEndDate = null;

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling((double)filteredEntries.Count / pageSize);

    private List<JournalEntry> paginatedEntries => 
        filteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();

    protected override void OnInitialized()
    {
        LoadEntries();
    }

    private void LoadEntries()
    {
        allEntries = JournalService.GetAllEntries();
        filteredEntries = allEntries;
        currentPage = 1;
    }

    private void PerformSearch()
    {
        currentPage = 1;
        if (string.IsNullOrWhiteSpace(searchText))
        {
            ApplyFilters();
        }
        else
        {
            filteredEntries = JournalService.SearchEntries(searchText);
            ApplyDateAndMoodFilters();
        }
    }

    private void ApplyFilters()
    {
        currentPage = 1;
        filteredEntries = allEntries;

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            filteredEntries = JournalService.SearchEntries(searchText);
        }

        ApplyDateAndMoodFilters();
    }

    private void ApplyDateAndMoodFilters()
    {
        if (!string.IsNullOrEmpty(filterMood))
        {
            filteredEntries = filteredEntries.Where(e => 
                e.PrimaryMood == filterMood || 
                e.SecondaryMood1 == filterMood || 
                e.SecondaryMood2 == filterMood
            ).ToList();
        }

        if (filterStartDate.HasValue)
        {
            filteredEntries = filteredEntries.Where(e => e.EntryDate.Date >= filterStartDate.Value.Date).ToList();
        }

        if (filterEndDate.HasValue)
        {
            filteredEntries = filteredEntries.Where(e => e.EntryDate.Date <= filterEndDate.Value.Date).ToList();
        }
    }

    private void ClearFilters()
    {
        searchText = "";
        filterMood = "";
        filterStartDate = null;
        filterEndDate = null;
        currentPage = 1;
        LoadEntries();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
            currentPage--;
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
            currentPage++;
    }

    private void GoToPage(int page)
    {
        currentPage = page;
    }

    private void GoToFirstPage()
    {
        currentPage = 1;
    }

    private void GoToLastPage()
    {
        currentPage = totalPages;
    }

    private List<int> GetVisiblePageNumbers()
    {
        var pages = new List<int>();
        int start = Math.Max(1, currentPage - 2);
        int end = Math.Min(totalPages, currentPage + 2);

        for (int i = start; i <= end; i++)
        {
            pages.Add(i);
        }

        return pages;
    }

    private void EditEntry(int id)
    {
        Navigation.NavigateTo($"/entry-form/{id}");
    }

    private void GoToNewEntry()
    {
        Navigation.NavigateTo("/entry-form");
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }
}
