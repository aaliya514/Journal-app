@page "/dashboard"
@inject JournalService JournalService
@inject NavigationManager Navigation

<div style="min-height: 100vh; padding: 2rem;">
    <div style="max-width: 1400px; margin: 0 auto;">

        <div style="background: white; border-radius: 24px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1 style="font-size: 2rem; font-weight: 700; color: #6366f1;">Dashboard</h1>
                <p style="color: #64748b;">Track your journaling progress</p>
            </div>
            <button @onclick="GoToNewEntry" style="padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">New Entry</button>
        </div>

        <div style="background: white; border-radius: 24px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">Today's Entry</h2>
            <p style="color: #64748b; margin-bottom: 1rem;">@DateTime.Today.ToString("dddd, MMMM dd, yyyy")</p>

            @if (todayEntry != null)
            {
                <div style="padding: 1.5rem; background: #f0f9ff; border-radius: 12px; border: 2px solid #bae6fd;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <span style="padding: 0.5rem 1rem; border-radius: 20px; background: #6366f1; color: white; font-weight: 600;">@todayEntry.PrimaryMood</span>
                        <span style="color: #64748b;">@todayEntry.WordCount words</span>
                    </div>
                    <button @onclick="EditTodayEntry" style="padding: 0.5rem 1rem; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 8px; font-weight: 600; cursor: pointer;">Edit Entry</button>
                </div>
            }
            else
            {
                <div style="padding: 2rem; text-align: center; background: #f8fafc; border-radius: 12px; border: 2px dashed #e2e8f0;">
                    <p style="color: #94a3b8; margin-bottom: 1rem;">No entry yet for today</p>
                    <button @onclick="GoToNewEntry" style="padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">Write Today's Entry</button>
                </div>
            }
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #6366f1;">@currentStreak</div>
                <div style="color: #64748b; font-size: 0.875rem;">Current Streak</div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #6366f1;">@longestStreak</div>
                <div style="color: #64748b; font-size: 0.875rem;">Longest Streak</div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #6366f1;">@totalEntries</div>
                <div style="color: #64748b; font-size: 0.875rem;">Total Entries</div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;">@topMood</div>
                <div style="color: #64748b; font-size: 0.875rem;">Top Mood</div>
            </div>
        </div>

        <div style="background: white; border-radius: 24px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Mood Distribution</h2>

            <div style="margin-bottom: 1.25rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #10b981;">Positive</span>
                    <span style="font-weight: 700; color: #10b981;">@positivePercent%</span>
                </div>
                <div style="height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: @(positivePercent)%; background: #10b981; border-radius: 10px;"></div>
                </div>
            </div>

            <div style="margin-bottom: 1.25rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #3b82f6;">Neutral</span>
                    <span style="font-weight: 700; color: #3b82f6;">@neutralPercent%</span>
                </div>
                <div style="height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: @(neutralPercent)%; background: #3b82f6; border-radius: 10px;"></div>
                </div>
            </div>

            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #ef4444;">Negative</span>
                    <span style="font-weight: 700; color: #ef4444;">@negativePercent%</span>
                </div>
                <div style="height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: @(negativePercent)%; background: #ef4444; border-radius: 10px;"></div>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button @onclick="GoToJournalList" style="padding: 0.75rem 1.5rem; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 12px; font-weight: 600; cursor: pointer;">View All Entries</button>
            <button @onclick="GoToCalendar" style="padding: 0.75rem 1.5rem; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 12px; font-weight: 600; cursor: pointer;">Calendar View</button>
            <button @onclick="GoToSettings" style="padding: 0.75rem 1.5rem; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 12px; font-weight: 600; cursor: pointer;">Settings</button>
        </div>

    </div>
</div>

@code {
    private JournalEntry todayEntry = null;
    private int currentStreak = 0;
    private int longestStreak = 0;
    private int totalEntries = 0;
    private string topMood = "None";
    private double positivePercent = 0;
    private double neutralPercent = 0;
    private double negativePercent = 0;

    protected override void OnInitialized()
    {
        if (!JournalService.IsAuthenticated())
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        LoadDashboardData();
    }

    private void LoadDashboardData()
    {
        todayEntry = JournalService.GetEntryByDate(DateTime.Today);

        var allEntries = JournalService.GetAllEntries();
        totalEntries = allEntries.Count;

        var streaks = JournalService.CalculateStreaks();
        currentStreak = streaks.Current;
        longestStreak = streaks.Longest;

        var topMoodData = JournalService.GetMostFrequentMood();
        if (topMoodData.Count > 0)
        {
            topMood = topMoodData.Mood;
        }

        var moodDist = JournalService.GetMoodDistribution();
        int total = moodDist["Positive"] + moodDist["Neutral"] + moodDist["Negative"];
        if (total > 0)
        {
            positivePercent = Math.Round((double)moodDist["Positive"] / total * 100, 1);
            neutralPercent = Math.Round((double)moodDist["Neutral"] / total * 100, 1);
            negativePercent = Math.Round((double)moodDist["Negative"] / total * 100, 1);
        }
    }

    private void GoToNewEntry()
    {
        Navigation.NavigateTo("/entry-form");
    }

    private void EditTodayEntry()
    {
        if (todayEntry != null)
        {
            Navigation.NavigateTo("/entry-form/" + todayEntry.Id);
        }
    }

    private void GoToJournalList()
    {
        Navigation.NavigateTo("/journal-list");
    }

    private void GoToCalendar()
    {
        Navigation.NavigateTo("/calendar-view");
    }

    private void GoToSettings()
    {
        Navigation.NavigateTo("/settings");
    }
}
